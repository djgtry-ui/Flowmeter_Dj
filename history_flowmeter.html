<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Transfer Bahan Flowmeter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #0b1437; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-container {
            max-height: 550px; 
            overflow-y: auto;
            background-color: #111c44;
        }
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .table-fixed-head thead th {
            position: sticky; top: 0;
            background-color: #1b254b;
            z-index: 10;
            border-bottom: 2px solid #3b82f6;
            white-space: nowrap;
            text-align: center;
            padding: 12px 8px;
            font-size: 10px;
            text-transform: uppercase;
        }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .card-custom { background: #111c44; border: 1px solid #1b254b; }
    </style>
</head>
<body class="p-4 md:p-8">

    <script>
        // --- 1. SESSION & IDLE 1 MINUTE ---
        let userData = null;
        try { userData = JSON.parse(localStorage.getItem('user_data')); } catch(e) {}

        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }

        let idleTime = 0;
        function resetTimer() { idleTime = 0; }
        document.addEventListener('touchstart', resetTimer);
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('scroll', resetTimer);
        
        setInterval(function() {
            idleTime++;
            if (idleTime >= 60) { // 1 Menit
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }, 1000);

        function logoutUser() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-8 border-b border-white/10 pb-4">
            <div class="text-left">
                <h1 class="text-2xl font-bold uppercase tracking-widest text-white flex items-center gap-3">
                    <i class="fa-solid fa-clock-rotate-left text-blue-500"></i>
                    Riwayat <span class="text-blue-500">Transfer</span>
                </h1>
                <p class="text-slate-500 text-[10px] font-bold mt-1 uppercase tracking-widest">Operator: <span id="op-name" class="text-blue-400">---</span></p>
            </div>
            <div class="flex gap-2">
                <a href="status_flowmeter.html" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded shadow-lg text-xs font-bold text-white transition-all italic uppercase">üè† Dashboard</a>
                <a href="transaksi_flowmeter.html" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded shadow-lg text-xs font-bold text-white transition-all italic uppercase">üéÆ Transaksi</a>
                <button onclick="logoutUser()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded shadow-lg text-xs font-bold text-white transition-all italic uppercase">üîì Logout</button>
            </div>
        </header>

        <div class="card-custom rounded-lg p-6 mb-6 shadow-2xl border-l-4 border-blue-500">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div>
                    <label class="block text-[10px] font-bold mb-2 text-slate-500 uppercase">Mulai:</label>
                    <input type="date" id="startDate" class="w-full bg-[#0b1437] border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-[10px] font-bold mb-2 text-slate-500 uppercase">Akhir:</label>
                    <input type="date" id="endDate" class="w-full bg-[#0b1437] border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-[10px] font-bold mb-2 text-slate-500 uppercase">Mesin:</label>
                    <select id="fmFilter" class="w-full bg-[#0b1437] border border-slate-700 rounded px-3 py-2 text-sm text-white">
                        <option value="">Semua Mesin</option>
                        <option value="1">Mesin 1</option>
                        <option value="2">Mesin 2</option>
                        <option value="3">Mesin 3</option>
                        <option value="4">Mesin 4</option>
                        <option value="5">Mesin 5</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] font-bold mb-2 text-slate-500 uppercase">Cari:</label>
                    <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari PO..." class="w-full bg-[#0b1437] border border-slate-700 rounded px-3 py-2 text-sm text-white focus:border-blue-500">
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchData()" class="bg-emerald-600 hover:bg-emerald-700 px-3 py-2 rounded text-xs font-bold flex-1 text-white transition-all flex items-center justify-center gap-2 uppercase">
                        <i class="fa-solid fa-sync-alt"></i> Sync
                    </button>
                    <button id="btnDownload" onclick="downloadExcel()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-xs font-bold text-white flex items-center justify-center">
                        <i class="fa-solid fa-file-excel"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="card-custom rounded-lg shadow-2xl overflow-hidden">
            <div class="p-4 flex flex-wrap justify-between items-center bg-[#1b254b] border-b border-white/5">
                <span id="infoData" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Menunggu sinkronisasi...</span>
                <div class="flex items-center gap-2">
                    <button onclick="changePage('first')" class="bg-[#0b1437] hover:bg-blue-600 px-3 py-1 rounded text-[10px] font-bold transition uppercase">Awal</button>
                    <span id="pageIndicator" class="text-blue-500 text-[10px] font-black px-2">HAL 1</span>
                    <button onclick="changePage('next')" class="bg-[#0b1437] hover:bg-blue-600 px-3 py-1 rounded text-[10px] font-bold transition uppercase">Next</button>
                </div>
            </div>

            <div class="scroll-container">
                <table class="w-full text-left text-xs table-fixed-head" id="mainTable">
                    <thead>
                        <tr class="text-slate-400">
                            <th style="width: 80px;">LOG ID</th>
                            <th>WAKTU</th>
                            <th style="width: 60px;">MSN</th>
                            <th>JALUR/NAMA</th>
                            <th>MATERIAL</th>
                            <th>NO. PO</th>
                            <th>STOCK</th>
                            <th class="text-yellow-500">TARGET</th>
                            <th class="text-green-500">AKTUAL</th>
                            <th class="text-blue-400">KET</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="10" class="p-20 text-center italic opacity-30 text-lg uppercase">Klik SYNC untuk memuat data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const BASE_API_URL = "https://plantopr.propanraya.com/api/flowmeter/log_flowmeter";
        const AUTH_HEADER = "Basic bnVyZGpheWEuYXRtYWphQHByb3BhbnJheWEuY29tOmllcHJvcGFu";
        
        let allRawData = [];
        let currentPage = 1;
        const rowsPerPage = 50;

        window.onload = () => {
            if(userData) document.getElementById('op-name').innerText = userData.username;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        };

        function formatDisplayNum(val) {
            let num = parseFloat(val) || 0;
            return num.toLocaleString('id-ID', { minimumFractionDigits: 2 });
        }

        // --- FETCH DATA MENGGUNAKAN XHR (WEBVIEWER FRIENDLY) ---
        function fetchData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const fm = document.getElementById('fmFilter').value;
            const tbody = document.getElementById('tableBody');
            const info = document.getElementById('infoData');

            info.innerText = "‚è≥ PROCESSING DATA...";
            tbody.innerHTML = '<tr><td colspan="10" class="p-20 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl mb-2 text-blue-500"></i></td></tr>';

            let finalUrl = BASE_API_URL + "?tanggal_mulai=" + start + "&tanggal_akhir=" + end;
            if(fm) finalUrl += "&id_mesin=" + fm;

            const xhr = new XMLHttpRequest();
            xhr.open("GET", finalUrl, true);
            xhr.setRequestHeader("Authorization", AUTH_HEADER);
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const result = JSON.parse(xhr.responseText);
                        allRawData = Array.isArray(result) ? result : (result.data || []);
                        allRawData.sort((a, b) => parseInt(b.log_id || 0) - parseInt(a.log_id || 0));
                        currentPage = 1;
                        renderTable();
                    } catch(e) { 
                        tbody.innerHTML = '<tr><td colspan="10" class="p-10 text-center text-red-500">Format Data Salah</td></tr>';
                    }
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" class="p-10 text-center text-red-500">Gagal Koneksi Server</td></tr>';
                }
            };
            xhr.onerror = function() { info.innerText = "ERROR CONNECTION"; };
            xhr.send();
        }

        function getFilteredUniqueData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const seen = new Set();
            return allRawData.filter(item => {
                const uniqueKey = item.id_mesin + "-" + item.NoPO + "-" + item.Aktual + "-" + item.keterangan;
                const searchStr = (item.NoPO + " " + item.Nama_Material + " " + item.keterangan).toLowerCase();
                if (seen.has(uniqueKey) || !searchStr.includes(search)) return false;
                seen.add(uniqueKey);
                return true;
            });
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const filtered = getFilteredUniqueData();
            const startIdx = (currentPage - 1) * rowsPerPage;
            const pageData = filtered.slice(startIdx, startIdx + rowsPerPage);
            
            tbody.innerHTML = '';
            if(pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="p-20 text-center opacity-50">Data Kosong</td></tr>';
                return;
            }

            pageData.forEach(item => {
                tbody.innerHTML += `<tr>
                    <td class="text-slate-500 font-mono text-[10px]">${item.log_id}</td>
                    <td class="text-slate-400 text-[10px]">${item.log_timestamp || item.created_at}</td>
                    <td class="text-blue-500 font-black">${item.id_mesin}</td>
                    <td class="text-indigo-300 font-bold text-[10px]">${item.Nama_ID || '-'}</td>
                    <td class="font-bold text-slate-200 text-[10px]">${item.Nama_Material || '-'}</td>
                    <td class="text-slate-400 font-mono text-[10px]">${item.NoPO || '-'}</td>
                    <td class="font-mono text-slate-500 text-[11px]">${formatDisplayNum(item.Stock)}</td>
                    <td class="font-mono text-yellow-500 font-black text-[11px]">${formatDisplayNum(item.Target)}</td>
                    <td class="font-mono text-green-500 font-black text-[11px]">${formatDisplayNum(item.Aktual)}</td>
                    <td class="text-blue-400 font-bold text-[10px] italic">${item.keterangan || '-'}</td>
                </tr>`;
            });

            const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
            document.getElementById('pageIndicator').innerText = "HAL " + currentPage + " / " + totalPages;
            document.getElementById('infoData').innerText = filtered.length + " BARIS DITEMUKAN";
        }

        function changePage(action) {
            const filtered = getFilteredUniqueData();
            const totalPages = Math.ceil(filtered.length / rowsPerPage);
            if (action === 'next' && currentPage < totalPages) currentPage++;
            else if (action === 'first') currentPage = 1;
            renderTable();
            document.querySelector('.scroll-container').scrollTop = 0;
        }

        // --- SOLUSI DOWNLOAD EXCEL UNTUK APK ---
        function downloadExcel() {
            if (userData && userData.akses && userData.akses.download != 1) {
                alert("Akses download ditolak.");
                return;
            }

            const dataToDownload = getFilteredUniqueData();
            if (dataToDownload.length === 0) {
                alert("Tidak ada data.");
                return;
            }

            const worksheetData = dataToDownload.map(item => ({
                "LOG_ID": item.log_id, "WAKTU": item.log_timestamp, "MSN": item.id_mesin,
                "PO": item.NoPO, "TARGET": parseFloat(item.Target || 0), "AKTUAL": parseFloat(item.Aktual || 0),
                "KET": item.keterangan
            }));

            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Log");

            // Trik untuk WebViewer: Kirim Base64 ke MIT App Inventor
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'base64' });
            
            if (window.AppInventor) {
                // Kirim data ke MIT App Inventor (Harus ditangkap dengan WebViewer.WebViewStringChange)
                window.AppInventor.setWebViewString("DOWNLOAD_EXCEL|" + wbout);
                alert("Perintah download dikirim ke sistem aplikasi...");
            } else {
                // Jika dibuka di browser biasa
                XLSX.writeFile(workbook, "History_Flowmeter.xlsx");
            }
        }
    </script>
</body>
</html>
