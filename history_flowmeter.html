<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Transfer Bahan - Flowmeter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { background-color: #0b1437; color: #e2e8f0; font-family: 'Inter', sans-serif; margin: 0; }
        .scroll-container { max-height: 500px; overflow-y: auto; background-color: #111c44; }
        .card-custom { background: #111c44; border: 1px solid #1b254b; }
        input, select { background: #0b1437 !important; border: 1px solid #1b254b !important; color: white !important; }
        table { border-collapse: collapse; width: 100%; min-width: 750px; }
        .table-head-sticky thead th { 
            position: sticky; top: 0; background: #1b254b; z-index: 20; 
            border-bottom: 2px solid #3b82f6; padding: 12px 8px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
            <div>
                <h1 class="text-xl font-bold uppercase text-white flex items-center gap-2">
                    <i class="fa-solid fa-history text-blue-500"></i> Riwayat <span class="text-blue-500">Log</span>
                </h1>
                <p id="welcomeUser" class="text-[10px] text-slate-500 font-bold uppercase italic">Operator: LOADING...</p>
            </div>
            <div class="flex gap-2">
                <a href="status_flowmeter.html" class="bg-indigo-600 px-3 py-2 rounded text-[10px] font-bold text-white italic uppercase shadow-lg border-b-2 border-indigo-900">üè† Dashboard</a>
                <a href="transaksi_flowmeter.html" class="bg-blue-600 px-3 py-2 rounded text-[10px] font-bold text-white italic uppercase shadow-lg border-b-2 border-blue-900">üéÆ Transaksi</a>
                <a href="index.html" onclick="localStorage.clear()" class="bg-red-600 hover:bg-red-700 px-5 py-2 rounded shadow-lg text-xs font-semibold text-white transition-all italic border-b-2 border-red-900">üîì LOGOUT</a>
            </div>
        </header>

        <div class="card-custom rounded-lg p-5 mb-6 border-l-4 border-blue-500 shadow-xl">
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div>
                    <label class="block text-[9px] font-bold mb-1 text-slate-500 uppercase">Dari Tanggal:</label>
                    <input type="date" id="startDate" class="w-full rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-[9px] font-bold mb-1 text-slate-500 uppercase">Sampai Tanggal:</label>
                    <input type="date" id="endDate" class="w-full rounded px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-[9px] font-bold mb-1 text-slate-500 uppercase">Pilih Mesin:</label>
                    <select id="fmFilter" class="w-full rounded px-3 py-2 text-sm">
                        <option value="">Semua Mesin</option>
                        <option value="1">Mesin 1 (TH SMT)</option>
                        <option value="2">Mesin 2 (TH P-01)</option>
                        <option value="3">Mesin 3 (TH V-09)</option>
                        <option value="4">Mesin 4 (TH P-05)</option>
                        <option value="5">Mesin 5 (TH WF)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[9px] font-bold mb-1 text-slate-500 uppercase">Pencarian:</label>
                    <input type="text" id="searchInput" onkeyup="renderTable()" placeholder="Cari PO/Material..." class="w-full rounded px-3 py-2 text-sm focus:border-blue-500 outline-none">
                </div>
                <div class="flex gap-2">
                    <button onclick="fetchDataXHR()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded text-xs font-bold text-white flex-1 flex items-center justify-center gap-2 uppercase transition-all">
                        <i class="fa-solid fa-sync"></i> Sync
                    </button>
                    <button onclick="downloadExcel()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-xs font-bold text-white flex items-center justify-center shadow-lg transition-all">
                        <i class="fa-solid fa-file-download"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="card-custom rounded-lg shadow-2xl overflow-hidden">
            <div class="p-3 flex justify-between items-center bg-[#1b254b] border-b border-white/5">
                <span id="infoData" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest italic">Siap</span>
                <div class="flex items-center gap-2">
                    <button onclick="changePage(-1)" class="bg-[#0b1437] hover:bg-blue-600 px-3 py-1 rounded text-[10px] font-bold uppercase">Prev</button>
                    <span id="pageIndicator" class="text-blue-500 text-[10px] font-black mx-1">HAL 1</span>
                    <button onclick="changePage(1)" class="bg-[#0b1437] hover:bg-blue-600 px-3 py-1 rounded text-[10px] font-bold uppercase">Next</button>
                </div>
            </div>

            <div class="scroll-container no-scrollbar overflow-x-auto">
                <table id="mainTable" class="table-head-sticky">
                    <thead>
                        <tr class="text-slate-400 text-[10px]">
                            <th class="text-left">LOG ID</th>
                            <th class="text-left">WAKTU</th>
                            <th class="text-center">MESIN</th>
                            <th class="text-left">MATERIAL</th>
                            <th class="text-left">NO. PO</th>
                            <th class="text-right">TARGET</th>
                            <th class="text-right text-emerald-400">AKTUAL</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody" class="text-[11px]">
                        <tr><td colspan="7" class="p-20 text-center italic opacity-30 uppercase tracking-widest">Klik Sync untuk memuat data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SESSION & USER DISPLAY ---
        function initUser() {
            try {
                const userData = JSON.parse(localStorage.getItem('user_data'));
                if (!localStorage.getItem('isLoggedIn')) {
                    window.location.href = 'index.html';
                }
                if (userData) {
                    document.getElementById('welcomeUser').innerHTML = `Operator: <span class="text-blue-400">${userData.username.toUpperCase()}</span>`;
                }
            } catch(e) { console.log("Init error"); }
        }
        initUser();

        // Re-check nama operator jika tadinya loading (khas WebViewer)
        setTimeout(initUser, 1500);

        // --- 2. CONFIG & STATE ---
        const API_URL = "https://plantopr.propanraya.com/api/flowmeter/log_flowmeter";
        const AUTH_HEADER = 'Basic bnVyZGpheWEuYXRtYWphQHByb3BhbnJheWEuY29tOmllcHJvcGFu';
        
        let allRawData = [];
        let currentPage = 1;
        const rowsPerPage = 50;

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;

        // --- 3. FETCH DATA (XHR METHOD) ---
        function fetchDataXHR() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const fm = document.getElementById('fmFilter').value;
            const tbody = document.getElementById('tableBody');
            const info = document.getElementById('infoData');

            info.innerText = "LOADING DATA...";
            tbody.innerHTML = '<tr><td colspan="7" class="p-20 text-center"><i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500"></i></td></tr>';

            let url = API_URL + "?tanggal_mulai=" + start + "&tanggal_akhir=" + end;
            if(fm) url += "&id_mesin=" + fm;

            const xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.setRequestHeader("Authorization", AUTH_HEADER);
            xhr.timeout = 20000;

            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const json = JSON.parse(xhr.responseText);
                        allRawData = Array.isArray(json) ? json : (json.data || []);
                        allRawData.sort((a, b) => b.log_id - a.log_id);
                        currentPage = 1;
                        renderTable();
                    } catch(e) {
                        tbody.innerHTML = '<tr><td colspan="7" class="p-20 text-center text-red-500 uppercase font-bold">Data tidak terbaca</td></tr>';
                    }
                } else {
                    Swal.fire('Error', 'Server Error: ' + xhr.status, 'error');
                }
            };

            xhr.onerror = function() {
                Swal.fire('Offline', 'Cek koneksi internet Anda.', 'error');
            };

            xhr.send();
        }

        // --- 4. RENDER & PAGINATION ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            const seen = new Set();
            const filtered = allRawData.filter(item => {
                const key = item.id_mesin + "-" + item.NoPO + "-" + item.Aktual;
                const matchSearch = (item.NoPO + " " + item.Nama_Material).toLowerCase().includes(search);
                if (seen.has(key) || !matchSearch) return false;
                seen.add(key);
                return true;
            });

            const startIdx = (currentPage - 1) * rowsPerPage;
            const paginated = filtered.slice(startIdx, startIdx + rowsPerPage);
            
            let html = "";
            if(paginated.length === 0) {
                html = '<tr><td colspan="7" class="p-10 text-center opacity-40 italic font-bold">DATA TIDAK ADA</td></tr>';
            } else {
                paginated.forEach(row => {
                    html += `<tr class="border-b border-white/5 hover:bg-blue-500/5 transition-all">
                        <td class="p-3 text-slate-500 font-mono">${row.log_id}</td>
                        <td class="p-3 text-slate-400 font-bold">${row.log_timestamp || row.created_at}</td>
                        <td class="p-3 text-center text-blue-400 font-black">${row.id_mesin}</td>
                        <td class="p-3 font-semibold text-slate-200">${row.Nama_Material || '-'}</td>
                        <td class="p-3 text-slate-400">${row.NoPO || '-'}</td>
                        <td class="p-3 text-right font-mono text-yellow-500">${parseFloat(row.Target || 0).toFixed(2)}</td>
                        <td class="p-3 text-right font-mono text-emerald-400 font-bold">${parseFloat(row.Aktual || 0).toFixed(2)}</td>
                    </tr>`;
                });
            }
            tbody.innerHTML = html;

            const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
            document.getElementById('pageIndicator').innerText = "HAL " + currentPage + " / " + totalPages;
            document.getElementById('infoData').innerText = filtered.length + " BARIS DITEMUKAN";
        }

        function changePage(dir) {
            currentPage += dir;
            if (currentPage < 1) currentPage = 1;
            renderTable();
        }

        // --- 5. DOWNLOAD EXCEL (BYPASS LOADING) ---
        function downloadExcel() {
            let user = null;
            try { user = JSON.parse(localStorage.getItem('user_data')); } catch(e){}

            // Jika di MIT App Inventor, bypass pengecekan ketat agar tombol tetap jalan
            const isMIT = window.AppInventor;
            const canDownload = (user && (user.akses.download == 1 || user.akses.download == "1"));

            if (!canDownload && !isMIT) {
                Swal.fire('Ditolak', 'Sesi login belum siap atau Anda tidak punya akses.', 'error');
                return;
            }

            const dataToDownload = allRawData; // Ambil semua data yang sudah di-sync
            if (dataToDownload.length === 0) {
                Swal.fire('Kosong', 'Sync data terlebih dahulu!', 'warning');
                return;
            }

            const t1 = document.getElementById('startDate').value;
            const t2 = document.getElementById('endDate').value;
            const fileName = `Log_Dj_Flowmeter_${t1}_to_${t2}.xlsx`;

            try {
                const wsData = dataToDownload.map(item => ({
                    "LOG ID": item.log_id,
                    "WAKTU": item.log_timestamp,
                    "MESIN": item.id_mesin,
                    "MATERIAL": item.Nama_Material,
                    "NO PO": item.NoPO,
                    "TARGET": parseFloat(item.Target || 0),
                    "AKTUAL": parseFloat(item.Aktual || 0)
                }));

                const ws = XLSX.utils.json_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "History");

                if (window.AppInventor) {
                    const b64 = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
                    // Format kirim ke MIT: DOWNLOAD_EXCEL | NamaFile | DataBase64
                    window.AppInventor.setWebViewString(`DOWNLOAD_EXCEL|${fileName}|${b64}`);
                    Swal.fire({ icon: 'success', title: 'Berhasil', text: 'Data sedang diproses HP.', timer: 2000, showConfirmButton: false });
                } else {
                    XLSX.writeFile(wb, fileName);
                }
            } catch (err) {
                Swal.fire('Gagal', 'Gagal membuat file Excel.', 'error');
            }
        }
    </script>
</body>
</html>
