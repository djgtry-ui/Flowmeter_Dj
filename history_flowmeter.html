<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Flowmeter - Cloud Propan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-container { max-height: 550px; overflow-y: auto; background-color: #1e293b; }
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .table-fixed-head thead th { position: sticky; top: 0; background-color: #334155; z-index: 10; border-bottom: 2px solid #3b82f6; white-space: nowrap; padding: 12px 8px; }
        .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.1); }
        td { padding: 8px; text-align: center; border-bottom: 1px solid #334155; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold uppercase tracking-widest text-white">Log Transfer Flowmeter</h1>
        <p class="text-blue-400 text-[10px] opacity-70 mt-1">GITHUB PAGES DEPLOYMENT (CORS BYPASS)</p>
    </div>

    <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-2xl border border-slate-700">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Tanggal Mulai:</label>
                <input type="date" id="startDate" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Tanggal Akhir:</label>
                <input type="date" id="endDate" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">ID Mesin:</label>
                <input type="number" id="fmFilter" placeholder="Contoh: 5" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
            </div>
            <button onclick="fetchData()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-xs font-bold text-white h-[38px]">
                <i class="fa-solid fa-sync-alt mr-2"></i>AMBIL DATA
            </button>
        </div>
    </div>

    <div class="bg-slate-800 rounded-lg shadow-2xl border border-slate-700 overflow-hidden">
        <div class="p-4 flex justify-between bg-slate-800/50">
            <span id="infoData" class="text-xs text-slate-400 italic">Menunggu input...</span>
        </div>
        <div class="scroll-container">
            <table class="w-full text-[11px] table-fixed-head">
                <thead>
                    <tr class="text-slate-200">
                        <th>LOG ID</th><th>WAKTU</th><th>MSN</th><th>NAMA ID</th><th>MATERIAL</th><th>PO</th><th class="text-right">TARGET</th><th class="text-right">AKTUAL</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="8" class="p-20 text-center opacity-40">Klik tombol AMBIL DATA</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Set default tanggal hari ini
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').value = today;
        document.getElementById('endDate').value = today;

        async function fetchData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const msn = document.getElementById('fmFilter').value;
            const tbody = document.getElementById('tableBody');
            const info = document.getElementById('infoData');

            tbody.innerHTML = '<tr><td colspan="8" class="p-20 text-center italic">⏳ Sedang menembus CORS via Proxy...</td></tr>';

            const targetUrl = `https://plantopr.propanraya.com/api/flowmeter/log_flowmeter?tanggal_mulai=${start}&tanggal_akhir=${end}${msn ? '&id_mesin='+msn : ''}`;
            
            // Menggunakan Proxy Cors-Anywhere atau AllOrigins
            // Kita coba AllOrigins karena tidak butuh request akses manual
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const json = await response.json();
                
                // AllOrigins mengembalikan data dalam bentuk string di field "contents"
                const result = JSON.parse(json.contents);

                if (result.status === "success") {
                    const data = result.data || [];
                    info.innerText = `Berhasil mengambil ${data.length} data.`;
                    
                    tbody.innerHTML = data.map(item => `
                        <tr class="table-row-hover">
                            <td class="font-mono text-slate-500">${item.log_id}</td>
                            <td>${item.log_timestamp}</td>
                            <td class="font-bold text-blue-400">${item.id_mesin}</td>
                            <td class="text-indigo-300">${item.Nama_ID}</td>
                            <td class="text-slate-200">${item.Nama_Material}</td>
                            <td>${item.NoPO}</td>
                            <td class="text-right text-yellow-500">${parseFloat(item.Target).toFixed(2)}</td>
                            <td class="text-right text-green-500 font-bold">${parseFloat(item.Aktual).toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    throw new Error("API mengembalikan status gagal");
                }
            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="8" class="p-10 text-center text-red-400 font-bold">⚠️ GAGAL: Browser memblokir koneksi (CORS).<br><span class="font-normal text-[10px]">Coba gunakan browser lain atau buka akses CORS di server API.</span></td></tr>`;
            }
        }
    </script>
</body>
</html>
