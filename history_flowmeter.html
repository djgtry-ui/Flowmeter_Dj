<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Flowmeter - GitHub Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .scroll-container { max-height: 550px; overflow-y: auto; background-color: #1e293b; border-radius: 0 0 0.5rem 0.5rem; }
        .scroll-container::-webkit-scrollbar { width: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 4px; }
        .table-fixed-head thead th { position: sticky; top: 0; background-color: #334155; z-index: 10; border-bottom: 2px solid #3b82f6; white-space: nowrap; padding: 12px 8px; }
        .table-row-hover:hover { background-color: rgba(59, 130, 246, 0.1); }
        td { padding: 10px 8px; text-align: center; }
        .text-right-aligned { text-align: right !important; padding-right: 20px; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="text-center mb-8">
        <h1 class="text-2xl font-bold uppercase tracking-widest text-white">Riwayat Transfer Bahan</h1>
        <p class="text-blue-400 text-[10px] opacity-70 mt-1">DEPLOYED ON GITHUB PAGES</p>
    </div>

    <div class="bg-slate-800 rounded-lg p-6 mb-6 shadow-2xl border border-slate-700">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Tanggal Mulai:</label>
                <input type="date" id="startDate" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Tanggal Akhir:</label>
                <input type="date" id="endDate" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
            </div>
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Mesin:</label>
                <select id="fmFilter" class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white">
                    <option value="">Semua Mesin</option>
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Mesin ${i}</option>`);</script>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold mb-2 text-slate-400">Cari Data:</label>
                <input type="text" id="searchInput" placeholder="Cari PO/Material..." class="w-full bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-white focus:border-blue-500">
            </div>
            <div class="flex space-x-2">
                <button onclick="fetchData()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded text-xs font-bold flex-1 text-white">
                    <i class="fa-solid fa-sync-alt mr-1"></i> Sync Data
                </button>
            </div>
        </div>
    </div>

    <div class="bg-slate-800 rounded-lg shadow-2xl border border-slate-700 overflow-hidden">
        <div class="p-4 flex justify-between items-center bg-slate-800/50 border-b border-slate-700">
            <span id="infoData" class="text-xs text-slate-300 italic">Klik Sync...</span>
            <div id="pagination" class="flex space-x-1">
                <button onclick="changePage('first')" class="bg-slate-700 px-3 py-1 rounded text-xs">Awal</button>
                <button id="pageIndicator" class="bg-blue-600 px-4 py-1 rounded text-xs font-bold">1</button>
                <button onclick="changePage('next')" class="bg-slate-700 px-3 py-1 rounded text-xs">»</button>
            </div>
        </div>

        <div class="scroll-container">
            <table class="w-full text-left text-xs table-fixed-head">
                <thead>
                    <tr class="text-slate-200">
                        <th>LOG ID</th><th>WAKTU</th><th>MSN</th><th>NAMA ID</th><th>MATERIAL</th><th>PO</th><th>PBI</th><th class="text-right-aligned">STOCK</th><th class="text-right-aligned text-yellow-400">TARGET</th><th class="text-right-aligned text-green-400">AKTUAL</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="10" class="p-20 text-center opacity-50">Menunggu Sinkronisasi...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allData = [];
        let currentPage = 1;
        const rowsPerPage = 50;

        window.onload = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
        };

        async function fetchData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const fm = document.getElementById('fmFilter').value;
            const tbody = document.getElementById('tableBody');
            
            tbody.innerHTML = '<tr><td colspan="10" class="p-20 text-center italic">⏳ Menembus CORS via Proxy...</td></tr>';

            const targetUrl = `https://plantopr.propanraya.com/api/flowmeter/log_flowmeter?tanggal_mulai=${start}&tanggal_akhir=${end}${fm ? '&id_mesin='+fm : ''}`;
            
            // Menggunakan proxy AllOrigins untuk mengatasi CORS di GitHub Pages
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

            try {
                const response = await fetch(proxyUrl);
                const json = await response.json();
                
                // AllOrigins membungkus data asli di dalam field "contents" sebagai string
                const result = JSON.parse(json.contents);
                
                allData = result.data || [];
                allData.sort((a, b) => parseInt(b.log_id) - parseInt(a.log_id));

                currentPage = 1;
                renderTable();
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="10" class="p-10 text-center text-red-500 font-bold">⚠️ Gagal terhubung! API Propan memblokir akses langsung (CORS).</td></tr>';
            }
        }

        function formatDisplayNum(val) {
            if (!val) return "0,00";
            return parseFloat(val).toLocaleString('id-ID', { minimumFractionDigits: 2 });
        }

        function renderTable() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('tableBody');
            
            let filtered = allData.filter(item => 
                `${item.NoPO} ${item.NoPBI} ${item.Nama_Material} ${item.Nama_ID}`.toLowerCase().includes(search)
            );

            const pageData = filtered.slice((currentPage - 1) * rowsPerPage, currentPage * rowsPerPage);
            tbody.innerHTML = pageData.map(item => `
                <tr class="table-row-hover border-b border-slate-700/50">
                    <td class="font-mono text-slate-500">${item.log_id}</td>
                    <td class="text-[10px] text-slate-400">${item.log_timestamp}</td>
                    <td class="font-bold text-blue-400">${item.id_mesin}</td>
                    <td class="text-indigo-300">${item.Nama_ID}</td>
                    <td class="text-slate-200">${item.Nama_Material}</td>
                    <td>${item.NoPO}</td>
                    <td>${item.NoPBI}</td>
                    <td class="text-right-aligned font-mono">${formatDisplayNum(item.Stock)}</td>
                    <td class="text-right-aligned font-mono text-yellow-500">${formatDisplayNum(item.Target)}</td>
                    <td class="text-right-aligned font-mono text-green-500 font-bold">${formatDisplayNum(item.Aktual)}</td>
                </tr>
            `).join('');

            document.getElementById('pageIndicator').innerText = currentPage;
            document.getElementById('infoData').innerText = `Total: ${filtered.length} baris`;
        }

        function changePage(action) {
            if (action === 'next' && currentPage * rowsPerPage < allData.length) currentPage++;
            else if (action === 'first') currentPage = 1;
            renderTable();
        }

        document.getElementById('searchInput').addEventListener('input', () => { currentPage = 1; renderTable(); });
    </script>
</body>
</html>
