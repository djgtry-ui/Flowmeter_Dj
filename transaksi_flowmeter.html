<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FLOWMETER SYSTEMS V2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #0b1437; color: #d1d5db; font-family: 'Plus Jakarta Sans', sans-serif; touch-action: manipulation; }
        .card-custom { background: #111c44; border: 1px solid #1b254b; border-radius: 12px; }
        .btn-machine { background: #1a2244; border: 1px solid #2d3748; padding: 10px 15px; border-radius: 8px; font-size: 11px; font-weight: 800; transition: 0.2s; color: #94a3b8; }
        .btn-machine.active { background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .outlet-btn { padding: 12px; border-radius: 8px; font-size: 11px; font-weight: 700; border: 1px solid #2d3748; background: #1a2244; color: #94a3b8; min-width: 80px; flex: 1; }
        .outlet-running { background: #facc15 !important; color: #000 !important; border-color: #eab308 !important; font-weight: 900; box-shadow: 0 0 15px rgba(250, 204, 21, 0.5); }
        .outlet-selected { border: 2px solid #3b82f6 !important; color: white; }
        .btn-ctrl { font-weight: 900; text-transform: uppercase; font-size: 11px; padding: 20px 10px; border-radius: 12px; transition: 0.2s; border-bottom: 4px solid rgba(0,0,0,0.3); color: white; display: flex; flex-direction: column; align-items: center; gap: 8px; width: 100%; }
        .btn-ctrl:active { transform: translateY(2px); border-bottom-width: 2px; }
        .val-mono { font-family: 'JetBrains Mono', monospace; }
        .input-transparent { background: transparent; border: none; outline: none; width: 100%; font-weight: 700; font-size: 14px; border-bottom: 1px solid transparent; transition: 0.3s; }
        .input-transparent:focus { border-bottom: 1px solid #3b82f6; color: #60a5fa; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-4 md:p-6">

    <script>
        // --- 1. SESSION & SECURITY ---
        let userData = null;
        try {
            userData = JSON.parse(localStorage.getItem('user_data'));
        } catch(e) { console.error("Storage Error"); }

        // Kick if not logged in
        if (!localStorage.getItem('isLoggedIn')) {
            window.location.href = 'index.html';
        }

        // --- 2. AUTO LOGOUT 1 MINUTE ---
        let idleTime = 0;
        function resetTimer() { idleTime = 0; }
        document.addEventListener('touchstart', resetTimer);
        document.addEventListener('mousedown', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('scroll', resetTimer);

        setInterval(function() {
            idleTime++;
            if (idleTime >= 60) { // 60 detik
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }, 1000);
    </script>

    <div class="max-w-7xl mx-auto space-y-6">
        <header class="flex justify-between items-center border-b border-white/10 pb-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg"><i class="fas fa-microchip"></i></div>
                <div>
                    <h1 class="text-xl font-extrabold text-white tracking-tight leading-none uppercase">Flowmeter <span class="text-blue-500">Systems</span></h1>
                    <p id="userLabel" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1 italic">Loading Access...</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <div id="conn-status" class="hidden md:flex items-center gap-2 bg-slate-900/50 px-3 py-2 rounded border border-white/5 mr-1 transition-all">
                    <span id="conn-icon" class="text-xs grayscale">üì∂</span>
                    <span id="conn-text" class="text-[9px] font-bold text-slate-500 uppercase tracking-tighter">API CHECK</span>
                </div>
                <a href="status_flowmeter.html" class="bg-indigo-600 hover:bg-indigo-700 px-5 py-2 rounded shadow-lg text-xs font-semibold text-white transition-all italic uppercase border-b-2 border-indigo-950">üè† Dashboard</a>
                <a href="history_flowmeter.html" class="bg-slate-600 hover:bg-slate-700 px-5 py-2 rounded shadow-lg text-xs font-semibold text-white transition-all italic uppercase border-b-2 border-slate-950">üìö History</a>
            </div>
        </header>

        <div id="machineList" class="flex flex-wrap gap-2 overflow-x-auto pb-2 no-scrollbar"></div>

        <div class="card-custom p-6 grid grid-cols-2 md:grid-cols-6 gap-6 border-l-4 border-blue-500 shadow-xl">
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">No PO</p><input type="text" id="d-po" class="input-transparent text-white" onchange="postData('NoPO', this.value)"></div>
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">No PBI</p><input type="text" id="d-pbi" class="input-transparent text-white" onchange="postData('NoPBI', this.value)"></div>
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">Material Name</p><input type="text" id="d-material" class="input-transparent text-emerald-400" onchange="postData('Nama_Material', this.value)"></div>
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">PIC</p><input type="text" id="d-pic" class="input-transparent text-white" onchange="postData('PIC', this.value)"></div>
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">Stock Avail</p><input type="text" id="d-stock" class="input-transparent text-blue-400" onchange="postData('Stock', this.value)"></div>
            <div><p class="text-[9px] text-slate-500 font-black uppercase mb-1">Active Machine</p><div id="d-mname" class="font-bold text-yellow-500 uppercase text-sm">--</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card-custom p-5">
                    <div class="flex justify-between items-center mb-4 text-[9px] font-black uppercase tracking-widest text-slate-500">
                        <span><i class="fas fa-route mr-2"></i>Status Outlet:</span>
                        <div class="flex gap-3">
                            <span class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400"></div> Running</span>
                            <span class="flex items-center gap-1"><div class="w-2 h-2 border border-blue-500"></div> Selected</span>
                        </div>
                    </div>
                    <div id="outletList" class="flex flex-wrap gap-2"></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="card-custom p-6 text-center border-t-2 border-blue-500/20">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Set Target (Kg)</p>
                        <input type="number" id="i-target" class="bg-transparent text-4xl font-black text-white val-mono text-center w-full focus:outline-none" step="0.01" onchange="postData('UPDATE_TARGET', this.value)">
                    </div>
                    <div class="card-custom p-6 text-center bg-emerald-500/5 border-t-2 border-emerald-500/20">
                        <p class="text-[10px] text-emerald-500/50 font-bold uppercase mb-2 tracking-widest">Actual Flow (Kg)</p>
                        <div id="d-aktual" class="text-4xl font-black text-emerald-500 val-mono">0.00</div>
                    </div>
                </div>

                <div class="card-custom p-5">
                    <div class="flex justify-between text-[10px] font-black mb-2 uppercase text-slate-400"><span>Progress Filling</span><span id="d-progress" class="text-emerald-500">0%</span></div>
                    <div class="w-full bg-slate-900 rounded-full h-3 p-[2px] border border-white/5">
                        <div id="progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-500 shadow-[0_0_12px_#10b981]" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card-custom p-6 space-y-4 border-r-4 border-blue-500">
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5 pb-2">Monitoring Detail</p>
                    <div class="flex justify-between items-center text-xs">
                        <span class="text-slate-400">Nama Jalur</span>
                        <input type="text" id="d-out-name" class="text-right bg-transparent font-bold text-blue-400 focus:outline-none" onchange="postData('Outlet_Nama', this.value)">
                    </div>
                    <div class="flex justify-between text-xs"><span class="text-slate-400">Outlet ID</span><span id="d-sysid" class="font-mono text-slate-300">--</span></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="postData('START')" class="btn-ctrl bg-[#10b981] active:bg-[#059669]"><i class="fas fa-play text-xl"></i> START</button>
                    <button onclick="postData('STOP')" class="btn-ctrl bg-[#f59e0b] active:bg-[#d97706]"><i class="fas fa-stop text-xl"></i> STOP</button>
                    <button onclick="postData('RESET')" class="btn-ctrl bg-[#e11d48] active:bg-[#be123c]"><i class="fas fa-undo text-xl"></i> RESET</button>
                    <button onclick="postData('MASTER_RESET')" class="btn-ctrl bg-[#450a0a] active:bg-black"><i class="fas fa-power-off text-xl"></i> MASTER RESET</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const API_GET = 'https://plantopr.propanraya.com/api/flowmeter/result_flowmeter';
    const API_POST = 'https://plantopr.propanraya.com/api/flowmeter/process';
    const AUTH_HEADER = "Basic bnVyZGpheWEuYXRtYWphQHByb3BhbnJheWEuY29tOmllcHJvcGFu";

    let activeMachineID = '1', userSelectedIdx = 1;
    let isUpdating = false;

    // Set Operator Label
    if(userData) {
        document.getElementById('userLabel').innerText = `CP V2.0 | OPERATOR: ${userData.username.toUpperCase()}`;
    } else {
        document.getElementById('userLabel').innerText = `CP V2.0 | ACCESS GRANTED`;
    }

    // Menggunakan XMLHttpRequest agar lebih stabil di WebViewer APK lama
    function fetchData() {
        if (isUpdating) return;
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `${API_GET}?id_mesin=${activeMachineID}`, true);
        xhr.setRequestHeader("Authorization", AUTH_HEADER);
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    const json = JSON.parse(xhr.responseText);
                    const data = Array.isArray(json) ? json[0] : (json.data ? json.data : json);
                    if (data) renderUI(data);
                } catch(e) {}
            }
        };
        xhr.send();
    }

    function formatDot(val) {
        let num = parseFloat(val) || 0;
        return num.toFixed(2); 
    }

    function renderUI(data) {
        if (!data) return;
        const activeEl = document.activeElement.id;
        
        // Update values only if not currently typing
        if(activeEl !== 'd-po') document.getElementById('d-po').value = data.NoPO || "";
        if(activeEl !== 'd-pbi') document.getElementById('d-pbi').value = data.NoPBI || "";
        if(activeEl !== 'd-material') document.getElementById('d-material').value = data.Nama_Material || "";
        if(activeEl !== 'd-pic') document.getElementById('d-pic').value = data.PIC || "";
        if(activeEl !== 'd-stock') document.getElementById('d-stock').value = formatDot(data.Stock);
        
        document.getElementById('d-mname').innerText = data.Nama_ID || "MACHINE " + activeMachineID;

        const outletAktifPLC = parseInt(data.Aktif_Outlet) || 0;
        const outList = document.getElementById('outletList');
        let outHTML = '';
        
        // Render up to 11 outlets
        for (let i = 1; i <= 11; i++) {
            const oName = data[`Outlet_${i}_Nama`];
            if (oName && oName !== "0" && oName !== 0) {
                outHTML += `<button onclick="selectOutlet(${i})" class="outlet-btn ${i == outletAktifPLC ? 'outlet-running' : ''} ${i == userSelectedIdx ? 'outlet-selected' : ''}">${oName}</button>`;
            }
        }
        outList.innerHTML = outHTML;

        const target = parseFloat(data[`Outlet_${userSelectedIdx}_Target`]) || 0;
        const aktual = parseFloat(data.Aktual) || 0;
        
        if(activeEl !== 'i-target') document.getElementById('i-target').value = formatDot(target);
        if(activeEl !== 'd-out-name') document.getElementById('d-out-name').value = data[`Outlet_${userSelectedIdx}_Nama`] || "";
        
        document.getElementById('d-aktual').innerText = formatDot(aktual);
        document.getElementById('d-sysid').innerText = userSelectedIdx;
        
        const progress = target > 0 ? Math.min((aktual/target)*100, 100) : 0;
        document.getElementById('d-progress').innerText = formatDot(progress) + "%";
        document.getElementById('progress-bar').style.width = progress + "%";
    }

    function postData(type, value = null) {
        isUpdating = true; 
        let payload = { id_mesin: activeMachineID };
        const prefix = `Outlet_${userSelectedIdx}_`;
        
        if (type === 'START') payload[prefix + 'Start'] = 1;
        else if (type === 'STOP') payload[prefix + 'Stop'] = 1;
        else if (type === 'RESET') payload[prefix + 'Reset'] = 1;
        else if (type === 'MASTER_RESET') payload['MstrReset'] = 1;
        else if (type === 'UPDATE_TARGET') payload[prefix + 'Target'] = parseFloat(value);
        else if (type === 'Outlet_Nama') payload[prefix + 'Nama'] = value;
        else payload[type] = value;

        const xhr = new XMLHttpRequest();
        xhr.open("POST", API_POST, true);
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Authorization", AUTH_HEADER);
        xhr.onload = function() {
            setTimeout(() => { isUpdating = false; fetchData(); }, 1200);
        };
        xhr.send(JSON.stringify(payload));
    }

    function checkServerConnection() {
        const xhr = new XMLHttpRequest();
        xhr.open("GET", `${API_GET}?id_mesin=1`, true);
        xhr.setRequestHeader("Authorization", AUTH_HEADER);
        xhr.timeout = 5000;
        const connBox = document.getElementById('conn-status');
        const connText = document.getElementById('conn-text');
        
        xhr.onload = function() {
            if (xhr.status === 200) {
                connBox.className = "flex items-center gap-2 bg-emerald-950/30 border border-emerald-500/30 px-3 py-2 rounded mr-1";
                connText.innerText = "(ONLINE)";
                connText.className = "text-[9px] font-bold text-emerald-400 uppercase tracking-tighter";
            }
        };
        xhr.onerror = function() {
            connBox.className = "flex items-center gap-2 bg-red-950/20 border border-red-500/50 px-3 py-2 rounded mr-1";
            connText.innerText = "OFFLINE";
            connText.className = "text-[9px] font-bold text-red-500 uppercase tracking-tighter";
        };
        xhr.send();
    }

    function selectOutlet(idx) { userSelectedIdx = idx; fetchData(); }
    function changeMachine(id, btnEl) {
        activeMachineID = id;
        document.querySelectorAll('.btn-machine').forEach(b => b.classList.remove('active'));
        btnEl.classList.add('active');
        fetchData();
    }

    // Init Machine List
    const machines = [{id:'1', name:'TH SMT'}, {id:'2', name:'TH P-01'}, {id:'3', name:'TH V-09'}, {id:'4', name:'TH P-05'}, {id:'5', name:'TH WF'}];
    document.getElementById('machineList').innerHTML = machines.map(m => `<button onclick="changeMachine('${m.id}', this)" class="btn-machine flex-shrink-0 ${m.id === activeMachineID ? 'active' : ''}">${m.name}</button>`).join('');

    // Intervals
    setInterval(fetchData, 1000);
    setInterval(checkServerConnection, 10000);
    fetchData();
    checkServerConnection();
    </script>
</body>
</html>
