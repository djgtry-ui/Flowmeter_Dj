<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMI Flowmeter Pro - Final System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #0b1437; color: #d1d5db; font-family: 'Plus Jakarta Sans', sans-serif; }
        .card-custom { background: #111c44; border: 1px solid #1b254b; border-radius: 12px; }
        
        /* Tombol Mesin Utama */
        .btn-machine { background: #1a2244; border: 1px solid #2d3748; padding: 10px; border-radius: 8px; font-size: 11px; font-weight: 800; transition: 0.2s; cursor: pointer; }
        .btn-machine.active { background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        
        /* Tombol Outlet */
        .outlet-btn { padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: 700; transition: 0.2s; border: 1px solid #2d3748; background: #1a2244; color: #94a3b8; }
        
        /* LOGIKA WARNA KUNING: Aktif di PLC (Kolom E) */
        .outlet-running { background: #facc15 !important; color: #000 !important; border-color: #eab308 !important; font-weight: 900; box-shadow: 0 0 15px rgba(250, 204, 21, 0.5); }
        
        /* LOGIKA BORDER BIRU: Dipilih User untuk Monitor */
        .outlet-selected { border: 2px solid #3b82f6 !important; color: white; }

        .btn-ctrl { font-weight: 900; text-transform: uppercase; font-size: 10px; padding: 12px 10px; border-radius: 10px; transition: all 0.2s; border-bottom: 4px solid rgba(0,0,0,0.3); color: white; }
        .btn-ctrl:active { transform: translateY(2px); border-bottom-width: 2px; }
        .val-mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <header class="flex justify-between items-center border-b border-white/10 pb-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg text-white shadow-lg"><i class="fas fa-microchip"></i></div>
                <div>
                    <h1 class="text-xl font-extrabold text-white tracking-tight leading-none">FLOWMETER <span class="text-blue-500">SYSTEMS</span></h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Control Panel V2.0</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex space-x-2">
                    <a href="index.html" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-sm font-medium text-white shadow-lg flex items-center transition">
                        üè† Dashboard
                    </a>

                    <a href="history_flowmeter.html" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded text-sm font-medium text-white shadow-lg flex items-center transition">
                        üìö History
                    </a>
                </div>
            </div>
        </header>

        <div id="machineList" class="flex flex-wrap gap-2"></div>

        <div class="card-custom p-6 grid grid-cols-2 md:grid-cols-6 gap-6 border-l-4 border-blue-500 shadow-xl">
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">No PO</p><div id="d-po" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">No PBI</p><div id="d-pbi" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Material Name</p><div id="d-material" class="font-bold text-emerald-400 text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">PIC</p><div id="d-pic" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Stock Avail</p><div id="d-stock" class="font-bold text-blue-400 text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Active Machine</p><div id="d-mname" class="font-bold text-yellow-500 uppercase text-sm">--</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card-custom p-5">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest"><i class="fas fa-route mr-2"></i>Status Outlet:</p>
                        <div class="flex gap-4 text-[9px] font-bold">
                            <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 bg-yellow-400 rounded-sm"></div> RUNNING (PLC)</div>
                            <div class="flex items-center gap-1"><div class="w-2.5 h-2.5 border-2 border-blue-500 rounded-sm"></div> SELECTED</div>
                        </div>
                    </div>
                    <div id="outletList" class="flex flex-wrap gap-3"></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="card-custom p-8 text-center border-t-2 border-blue-500/20">
                        <p class="text-[11px] text-slate-500 font-bold uppercase mb-4 tracking-widest">Set Target (Kg)</p>
                        <div id="d-target" class="text-6xl font-black text-white val-mono">0.00</div>
                    </div>
                    <div class="card-custom p-8 text-center bg-emerald-500/5 border-t-2 border-emerald-500/20">
                        <p class="text-[11px] text-emerald-500/50 font-bold uppercase mb-4 tracking-widest">Actual Flow (Kg)</p>
                        <div id="d-aktual" class="text-6xl font-black text-emerald-500 val-mono">0.00</div>
                    </div>
                </div>

                <div class="card-custom p-5">
                    <div class="flex justify-between text-[10px] font-black mb-2 uppercase text-slate-400"><span>Progress Filling</span><span id="d-progress" class="text-emerald-500">0%</span></div>
                    <div class="w-full bg-slate-900 rounded-full h-3 p-[2px] border border-white/5">
                        <div id="progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-700 shadow-[0_0_12px_#10b981]" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card-custom p-6 space-y-4 text-xs border-r-4 border-blue-500">
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5 pb-2">Monitoring Detail</p>
                    <div class="flex justify-between"><span>Nama Jalur</span><span id="d-route" class="font-bold text-blue-400">--</span></div>
                    <div class="flex justify-between"><span>Outlet ID</span><span id="d-sysid" class="font-mono text-slate-300">--</span></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="control('START')" class="btn-ctrl bg-emerald-600 hover:bg-emerald-500"><i class="fas fa-play mb-1 block text-lg"></i> Start</button>
                    <button onclick="control('STOP')" class="btn-ctrl bg-amber-500 hover:bg-amber-400"><i class="fas fa-stop mb-1 block text-lg"></i> Stop</button>
                    <button onclick="control('RESET')" class="btn-ctrl bg-rose-600 hover:bg-rose-500"><i class="fas fa-undo mb-1 block text-lg"></i> Reset</button>
                    <button onclick="control('MASTER_RESET')" class="btn-ctrl bg-[#7d1c1c] hover:bg-rose-900"><i class="fas fa-power-off mb-1 block text-lg"></i> Master Reset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '141uuIOYNPmIYjI6OvCHRbMOOXrWtfFVfAisAis0zL-0';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=result_flowmeter`;
        
        let activeMachineID = '1'; 
        let userSelectedIdx = 1; 

        function formatNum(val) {
            if (!val) return "0.00";
            let num = parseFloat(val.toString().replace(',', '.'));
            return isNaN(num) ? "0.00" : num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function fetchData() {
            try {
                const res = await fetch(`${CSV_URL}&t=${new Date().getTime()}`);
                const text = await res.text();
                const rows = text.split(/\r?\n/).filter(r => r.trim() !== "").map(row => {
                    return row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                const data = rows.find(r => r[1] === activeMachineID);
                if (data) renderUI(data);
            } catch (e) { console.error("Error:", e); }
        }

        function renderUI(data) {
            document.getElementById('d-po').innerText = data[6] || "--";
            document.getElementById('d-pbi').innerText = data[7] || "--";
            document.getElementById('d-material').innerText = data[9] || "--";
            document.getElementById('d-pic').innerText = data[10] || "0";
            document.getElementById('d-stock').innerText = formatNum(data[11]);
            document.getElementById('d-mname').innerText = data[5] || "--";

            const outletAktifPLC = parseInt(data[4]) || 0;
            const outList = document.getElementById('outletList');
            outList.innerHTML = '';

            for (let i = 1; i <= 11; i++) {
                const baseIdx = 15 + ((i - 1) * 9);
                const name = data[baseIdx];
                if (name && name !== "0" && name !== "" && name !== "...") {
                    const btn = document.createElement('button');
                    let classes = "outlet-btn ";
                    if (i === outletAktifPLC) classes += "outlet-running ";
                    if (i === userSelectedIdx) classes += "outlet-selected ";
                    btn.className = classes;
                    btn.innerText = name;
                    btn.onclick = () => { userSelectedIdx = i; fetchData(); };
                    outList.appendChild(btn);
                }
            }

            const selBaseIdx = 15 + ((userSelectedIdx - 1) * 9);
            const target = parseFloat(data[selBaseIdx + 1]?.replace(',', '.') || 0);
            const aktual = parseFloat(data[12]?.replace(',', '.') || 0);
            const progress = target > 0 ? Math.min((aktual/target)*100, 100) : 0;

            document.getElementById('d-target').innerText = formatNum(target);
            document.getElementById('d-aktual').innerText = formatNum(aktual);
            document.getElementById('d-route').innerText = data[selBaseIdx] || "--";
            document.getElementById('d-sysid').innerText = userSelectedIdx;
            document.getElementById('d-progress').innerText = progress.toFixed(2) + "%";
            document.getElementById('progress-bar').style.width = progress + "%";
        }

        const mList = document.getElementById('machineList');
        const machines = [
            {id: '1', name: 'TH SMT'}, {id: '2', name: 'TH P-01'}, {id: '3', name: 'TH V-09'},
            {id: '4', name: 'TH P-05'}, {id: '5', name: 'TH WF'}
        ];
        
        machines.forEach(m => {
            const btn = document.createElement('button');
            btn.className = `btn-machine ${m.id === activeMachineID ? 'active' : ''}`;
            btn.innerText = m.name;
            btn.onclick = () => {
                activeMachineID = m.id;
                document.querySelectorAll('.btn-machine').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                fetchData();
            };
            mList.appendChild(btn);
        });

        function control(type) { alert(`Sinyal ${type} dikirim untuk ID Outlet: ${userSelectedIdx}`); }

        fetchData();
        setInterval(fetchData, 3000);
    </script>
</body>
</html>
